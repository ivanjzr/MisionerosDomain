<?php

//
include PATH_BASE.DS.'js_versioning.phtml';
//
$user_info = $App::GetUserData();
//dd($user_info);



// 
$App::$header_scrits = <<<EOF
    <link rel="stylesheet" href="/adm/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <link rel="stylesheet" href="/adm/plugins/select2/css/select2.min.css">
    
    <style>
       
    </style>    
EOF;

//
$App::$footer_scripts = <<<EOF
    <script src="/adm/plugins/jquery-form/jquery.form.min.js"></script>
    <script src="/adm/plugins/jquery-validation/jquery.validate.js"></script>
    <script src="/adm/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <script src="/adm/plugins/select2/js/select2.full.min.js"></script>
    <script src="/adm/plugins/select2/js/i18n/es.js"></script>
    <script src="/adm/js/s2-extended.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.min.js" integrity="sha512-vs7+jbztHoMto5Yd/yinM4/y2DOkPLt0fATcN+j+G4ANY2z4faIzZIOMkpBmWdcxt+596FemCh9M18NUJTZwvw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
EOF;

///
$App::$footer_section_scripts = <<<EOF
    <script src="/app/pos/main.js?v=$js_files_version"></script>
EOF;

//
$App::setSectionInfo("Punto de Venta", "pos");
?>

<?php include PATH_VIEWS_ADMIN.DS.'common'.DS.'header-login.phtml'; ?>


<div id="section-main">

    <!-- Header & Navigation -->
    <div class="bg-light py-3" id="ko_header">
        <div class="container-fluid">
            <div class="card border-0 shadow-sm">
                <div class="card-body">                    
                    <div class="row align-items-center">
                        <div class="col-md-4">

                           <div class="d-flex align-items-center">
                                <a href="#!" class="me-3">
                                    <img src="/logos<?=$user_info['logo_path'];?>" 
                                        alt="<?=$user_info['app_name'];?>" 
                                        style="height: 40px; width: auto;">
                                </a>
                                <h4 class="mb-0 fw-bold">
                                    <i class="fas fa-cash-register me-2 text-primary"></i>
                                    Punto de Venta - <?=$user_info['caja_info']['pos_name'];?>
                                </h4>
                            </div>

                        </div>

                        <div class="col-md-4 text-center">

                            <?php 
                            //dd($user_info);
                            if ((isset($user_info['current_user']) && isset($user_info['current_user']['id']))){
                            
                                $current_user = $user_info['current_user'];
                                $str_pos_login_dt_expire_at = (isset($user_info['ses'][SES_POS_LOGIN_DT_EXPIRE_AT])) ? $user_info['ses'][SES_POS_LOGIN_DT_EXPIRE_AT] : "";
                                
                                //
                                $pos_login_dt_expire_at = "";
                                if ($str_pos_login_dt_expire_at){
                                    $pos_login_dt_expire_at = \DateTime::createFromFormat("Y-m-d H:i:s", $str_pos_login_dt_expire_at)->format("d M Y g:i:s A");
                                }
                            ?>
                            
                                <button type="button" class="btn btn-outline-success btnSelectUser">
                                    <i class="fas fa-exchange-alt me-1"></i> <?=$current_user['name'];?>
                                    <div style="font-size:10px;"> <?=$pos_login_dt_expire_at;?></div>
                                </button>

                                <input type="hidden" id="pos_user_id" name="pos_user_id" value="<?=$current_user['id'];?>" />
                                <input type="hidden" id="pos_user_name" name="pos_user_name" value="<?=$current_user['name'];?>" />                                

                            <?php } ?>

                        </div>
                        
                        <!-- Right: Config Menu -->
                        <div class="col-md-4 col-12 text-md-end">
                            
                            <div class="d-inline-flex align-items-center me-3">
                                <label class="form-label me-2 mb-0 text-muted">USD:</label>
                                <input type="text" 
                                    class="form-control form-control-sm text-center fw-bold" 
                                    style="width: 70px;" 
                                    data-bind="value: exchange_rate" 
                                    readonly>
                            </div>


                            <button type="button" class="btn btn-outline-secondary" data-bind="click: btnReload">
                                <i class="fas fa-sync"></i>
                            </button>

                            
                            <div class="dropdown d-inline-block me-2">
                                <button class="btn btn-outline-success dropdown-toggle" type="button" 
                                        id="importDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-cog me-2"></i>
                                    <span class="d-none d-sm-inline"></span>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="importDropdown" style="min-width: 250px;">
                                    <div class="d-grid gap-2">

                                    <?php 
                                        $userAuthenticated = isset($user_info['current_user']) && isset($user_info['current_user']['id']);
                                        $needsPin = isset($user_info['need_pin']) && $user_info['need_pin'] === 1;
                                        //
                                        if ($userAuthenticated && !$needsPin): 
                                        ?>
                                            <a href="/admin/pos/registers/<?=$user_info['ses'][SES_POS_REGISTER_ID];?>/view?retTo=sale" class="btn btn-outline-secondary">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                Detalle de Caja
                                            </a>
                                            <li><hr class="dropdown-divider"></li>
                                            <button type="button" class="btn btn-outline-danger" data-bind="click: btnCloseRegister">
                                                <i class="fas fa-cash-register me-2"></i>
                                                Cerrar Caja
                                            </button>
                                    <?php endif; ?>

                                        <a href="/admin/pos/index" class="btn btn-secondary">
                                            <i class="fas fa-arrow-left me-2"></i>
                                            Back
                                        </a>
                                    </div>
                                </div>
                            </div>

                        </div>


                    </div>
                </div>
            </div>  
        </div>
    </div>



    <!-- Main Content -->
    <main class="container-fluid py-2 px-5" id="ko_container">
        <?php if (!(isset($user_info['current_user']) && isset($user_info['current_user']['id']))): ?>

            <div class="d-flex flex-column justify-content-center align-items-center" style="min-height: 40vh;">
                <div class="text-center mb-4">
                    <div class="alert alert-primary" role="alert">
                        <h5 class="alert-heading mb-2">Seleccionar Usuario</h5>
                        <p class="mb-0">Por favor, seleccione usuario para continuar</p>
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-lg btnSelectUser">
                    Seleccionar Usuario
                </button>
            </div>
        
            <?php elseif (isset($user_info['need_pin']) && $user_info['need_pin'] === 1): ?>

            <div class="d-flex flex-column justify-content-center align-items-center" style="min-height: 40vh;">
                <div class="text-center mb-4">
                    <div class="alert alert-primary" role="alert">
                        <h5 class="alert-heading mb-2">PIN requerido</h5>
                        <p class="mb-0">Ingrese su PIN para continuar</p>
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-lg btnSetPin">
                    Ingresar PIN
                </button>
            </div>

        <?php else: ?>
            

            <div class="row">
                <div class="col-sm-4 col-12">
                    

                    <div class="table-responsive" style="height: 300px; padding:10px; overflow-y: auto;">
                        <table class="table table-striped table-sm" id="tbl_items">
                            <thead class="table-light">
                                <tr>
                                    <th>Code</th>
                                    <th>Nombre</th>                                    
                                    <th>Qty</th>
                                    <th>Monto</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody data-bind="if: items().length === 0">
                                <tr class="no-items-row">
                                    <td colspan="5" class="text-center">
                                        <div class="alert alert-info mb-0">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Sin items. Agregue productos para continuar.
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tbody data-bind="foreach: items">
                                <tr>
                                    <td data-bind="text: prod_code"></td>
                                    <td>
                                        <span data-bind="text: nombre"></span>
                                        <!-- ko if: employee -->
                                         <br />
                                        <small class="text-primary">
                                            <i class="fas fa-id-badge me-1"></i>
                                            <span data-bind="text: employee.name"></span> - <span data-bind="text: employee.job_title"></span>
                                        </small>
                                        <!-- /ko -->
                                    </td>
                                    <td>
                                        <td>

                                            <!-- ko if: !is_cita -->
                                            <div data-bind="visible: $parent.showItemsContainer" class="input-group input-group-sm" style="max-width: 120px;">
                                                <button data-bind="click: $parent.decreaseQty, enable: qty() > 1" 
                                                        type="button" class="btn btn-outline-secondary btn-sm">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input data-bind="value: qty, valueUpdate: 'input', event: {blur: $parent.validateQty, focus: $parent.selectAllText}" 
                                                    type="number" min="1" max="9999" step="1" class="form-control form-control-sm text-center" style="-webkit-appearance: none; -moz-appearance: textfield;" />
                                                <button data-bind="click: $parent.increaseQty" 
                                                        type="button" class="btn btn-outline-secondary btn-sm">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                            <!-- /ko -->

                                            <!-- ko if: is_cita -->
                                            <span data-bind="visible: $parent.showItemsContainer, text: qty" class="fw-bold"></span>
                                            <!-- /ko -->

                                            <!-- Modo solo lectura (cuando está en pagos) -->
                                            <span data-bind="visible: $parent.showPaymentContainer, text: qty" class="fw-bold"></span>

                                        </td>
                                    </td>

                                    <td data-bind="text: '$' + app.formatCurrency(parseFloat(precio) * qty()).toFixed(2)"></td>
                                    <td>
                                        <td>
                                            <button data-bind="visible: $parent.showItemsContainer, click: $parent.removeItem" type="button" class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <hr />


                    <div class="bg-light p-2 rounded">
                        <div class="row text-center">
                            <div class="col-3">
                                <small class="text-muted">Items</small><br>
                                <span data-bind="text: totalItems">0</span>
                            </div>
                            <div class="col-3">
                                <small class="text-muted">Cantidad</small><br>
                                <span data-bind="text: totalQty">0</span>
                            </div>
                            <div class="col-3">
                                <small class="text-muted">Descuentos</small><br>
                                <span data-bind="text: formattedDiscounts">$0.00</span>
                            </div>
                            <div class="col-3">
                                <small class="text-muted">Total</small><br>
                                <span data-bind="text: formattedTotal">$0.00</span>
                            </div>
                        </div>
                    </div>


                    <div class="my-3">
                        <textarea class="form-control" 
                                id="sale_notes" 
                                name="sale_notes"
                                data-bind="value: saleNotes"
                                rows="2"
                                placeholder="notas de Venta (Opcional)..."></textarea>
                    </div>

                    <div data-bind="visible: selectedCustomer" class="mt-2">
                        <div class="alert alert-light border d-flex justify-content-between align-items-center py-2">
                            <div>
                                <i class="fas fa-user me-2 text-primary"></i>
                                <span data-bind="text: selectedCustomer() ? selectedCustomer().name : ''" class="fw-bold"></span>
                                <small class="text-muted ms-2">
                                    (<span data-bind="text: selectedCustomer() ? selectedCustomer().email : ''"></span> | 
                                    <span data-bind="text: selectedCustomer() ? selectedCustomer().telefono : ''"></span>)
                                </small>
                            </div>

                            <!-- ko if: showItemsContainer() && selectedCustomer() --> 
                            <div class="d-flex gap-2">

                                <!-- ko if: !hasCitaItem() --> 
                                <button type="button" class="btn btn-outline-primary btn-sm" data-bind="click: btnSelectCustomerCitas">
                                    <i class="fas fa-arrow-right"></i> Cobrar Cita
                                </button>
                                <!-- /ko -->

                                <button type="button" class="btn btn-outline-danger btn-sm" data-bind="click: btnRemoveCustomer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <!-- /ko -->
                             
                        </div>
                    </div>


                    <div data-bind="visible: selectedPromo" class="mt-2">
                        <div class="alert alert-light border d-flex justify-content-between align-items-center py-2">
                            <div>
                                <i class="fas fa-gift me-2 text-info"></i>
                                <span data-bind="text: promoInfo" class="fw-bold"></span>
                                <small class="text-muted ms-2" data-bind="visible: promoDiscount">
                                    (<span data-bind="text: promoDiscount"></span>)
                                </small>
                            </div>
                            <!-- ko if: showItemsContainer() && selectedPromo() --> 
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-danger btn-sm" data-bind="click: btnRemovePromo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <!-- /ko -->
                        </div>
                    </div>

                    <div class="d-flex gap-2 flex-wrap mt-2">

                        <button type="button" class="btn btn-outline-warning" data-bind="click: resetItems">
                            <i class="fas fa-sync-alt"></i> Reiniciar
                        </button>
                        
                        <button type="button" class="btn btn-outline-warning" data-bind="click: selectPromo">
                            <i class="fas fa-gift"></i>
                        </button>

                        <button type="button" class="btn btn-outline-primary" data-bind="click: selectCustomer, visible: allowSelectCustomer">
                            <i class="fas fa-users"></i> Cliente
                        </button>

                        <button data-bind="visible: showPaymentButton, click: btnShowPayments" type="button" class="btn btn-primary" style="display:none;">
                            <i class="fas fa-arrow-right"></i> Pagar 
                        </button>

                        <button data-bind="visible: showSelectItemsButton, click: btnGoToItems, css: {'btn-warning': payments().length > 0, 'btn-outline-secondary': payments().length === 0}" type="button" class="btn">
                            <i class="fas fa-arrow-left"></i> 
                            <span data-bind="text: payments().length > 0 ? 'Modificar pedido' : 'Back'"></span>
                        </button>

                    </div>
                    
                </div>
                <div class="col-sm-8 col-12">


                    <div class="p-2" id="select_items_container" data-bind="visible: showItemsContainer">

                        <div class="row">
                            <div class="col-12">
                                <label for="product_id" class="form-label fw-medium">Buscar Productos/Servicios</label>
                                <select class="form-select" 
                                        data-rule-required="true" 
                                        data-msg-required="..." 
                                        data-rule-number="true" 
                                        id="product_id" 
                                        name="product_id">
                                    <option value="">-- Seleccionar producto --</option>
                                </select>
                            </div>
                        </div>

                        <hr />
                        <div class="row" id="products_list"></div>

                    </div>



                    <div class="p-5" id="select_payment_container" data-bind="visible: showPaymentContainer">

                        <!-- Métodos de pago -->
                        <div class="row" id="payments_methods"></div>

                        <!-- Tabla de pagos -->
                        <div class="table-responsive mb-3">
                            <table class="table table-striped table-sm" id="tbl_payments">
                                <thead class="table-light">
                                    <tr>
                                        <th>Método</th>
                                        <th>Monto</th>
                                        <th>USD</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody data-bind="if: payments().length === 0">
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Seleccione método de pago
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                                <tbody data-bind="foreach: payments">
                                    <tr>
                                        <td data-bind="text: payment_type"></td>
                                        <td>
                                            <!-- ko if: payment_type === 'Efectivo Dolares' -->
                                            <input data-bind="value: amount_mxn" 
                                                type="number" class="form-control form-control-sm" style="max-width: 100px;" 
                                                readonly placeholder="Auto">
                                            <!-- /ko -->
                                            <!-- ko if: payment_type !== 'Efectivo Dolares' -->
                                            <input data-bind="value: amount_mxn, valueUpdate: 'input', event: {blur: $parent.validatePaymentAmount, keydown: $parent.handleEnterKey, focus: $parent.selectAllText}" 
                                                type="number" min="0" step="1" class="form-control form-control-sm" style="max-width: 100px;" placeholder="MXN">
                                            <!-- /ko -->
                                        </td>
                                        <td>
                                            <!-- ko if: payment_type === 'Efectivo Dolares' -->
                                            <input data-bind="value: amount_usd, valueUpdate: 'input', event: {blur: $parent.validatePaymentAmount, keydown: $parent.handleEnterKey, focus: $parent.selectAllText}" 
                                                type="number" min="0" step="1" class="form-control form-control-sm" style="max-width: 80px;" placeholder="USD">
                                            <!-- /ko -->
                                            <!-- ko if: payment_type !== 'Efectivo Dolares' -->
                                            <span>-</span>
                                            <!-- /ko -->
                                        </td>
                                        <td>
                                            <button data-bind="click: $parent.removePayment" type="button" class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                         
                        <!-- Totales de pago -->
                        <div class="bg-light p-1 rounded mb-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Total Venta</small><br>
                                    <span data-bind="text: '$' + finalTotal().toFixed(2)" class="fw-bold"></span>
                                    &nbsp;<small data-bind="text: '( $' + finalTotalUsd().toFixed(2) + ' usd )'" class="text-secondary"></small>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Pagado</small><br>
                                    <span data-bind="text: '$' + (totalPaid() || 0).toFixed(2)" class="fw-bold text-success"></span>
                                </div>

                                <!-- ko if: remainingAmount() > 0 -->
                                <div class="col-4">
                                    <small class="text-muted">Restante</small><br>
                                    <span data-bind="text: '$' + (remainingAmount() || 0).toFixed(2), css: {'text-danger': remainingAmount() > 0, 'text-success': remainingAmount() === 0}" class="fw-bold"></span>
                                    &nbsp;<small data-bind="text: '( $' + remainingAmountUsd().toFixed(2) + ' usd )'" class="text-secondary"></small>
                                </div>
                                <!-- /ko -->

                                <!-- ko if: changeAmount() > 0 --> 
                                <div class="col-4">
                                    <small class="text-muted">Cambio</small><br>
                                    <span data-bind="text: '$' + (changeAmount() || 0).toFixed(2), css: {'text-success': changeAmount() > 0, 'text-muted': changeAmount() === 0}" class="fw-bold"></span>
                                    &nbsp;<small data-bind="text: '( $' + changeAmountUsd().toFixed(2) + ' usd )'" class="text-secondary"></small>
                                </div>
                                <!-- /ko -->
                                
                            </div>
                        </div>


                        <div class="d-flex justify-content-center my-5">
                            
                            <button data-bind="visible: showApplyPayments, click: addSale" type="button" class="btn btn-lg btn-success btnAddSale" style="width: 50%;">
                                <i class="fas fa-arrow-right"></i> Continuar
                            </button>

                            <div data-bind="visible: showNotFullyPaid" class="alert alert-warning mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Completa la cantidad faltante de <span data-bind="text: '$' + (remainingAmount() || 0).toFixed(2)"></span> para continuar
                            </div>

                        </div>

                        
                    </div>


                </div>
            </div>
            
        <?php endif; ?>
    </main>

    
    <input type="hidden" id="sel_suc_id" name="sel_suc_id" value="<?=$user_info['sucursal_id'];?>" />
    <input type="hidden" id="pos_register_id" name="pos_register_id" value="<?=$user_info['caja_info']['id'];?>" />
    <input type="hidden" id="pos_register_name" name="pos_register_name" value="<?=$user_info['caja_info']['pos_name'];?>" />
    <input type="hidden" id="need_pin" name="need_pin" value="<?=$user_info['need_pin'];?>" />
    <?php /*echo (new DateTime())->format("d M Y g:i:s A");*/ ?>

</div>

<?php include PATH_VIEWS_ADMIN.DS.'common'.DS.'footer.phtml'; ?>



